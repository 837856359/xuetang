<?php         namespace backend\modules\user\controllers;use Yii;use backend\modules\user\models\User;use backend\modules\user\models\UserSeach;use yii\web\Controller;use yii\web\NotFoundHttpException;use yii\filters\VerbFilter;use yii\web\PHPExcel;use yii\data\Pagination;use app\models\Comment;use yii\data\ArrayDataProvider;/** * PptController implements the CRUD actions for User model. */class PptController extends BaseController{    public $enableCsrfValidation = false;    public function behaviors()    {        return [            'verbs' => [                'class' => VerbFilter::className(),                'actions' => [                    'delete' => ['post'],                ],            ],        ];    }      	//显示ppt页面        public function actionPpt_add(){            $sql='select c_id,c_name from college';                     $one= Yii::$app->db->createCommand($sql)->queryAll();                    $sql1='select * from stage';                     $stage= Yii::$app->db->createCommand($sql1)->queryAll();                    $sql2='select * from ppt';                    $ppt=Yii::$app->db->createCommand($sql2)->queryAll();                   // print_r($ppt);die;            return $this->render('ppt_add',["one"=>$one,"stage"=>$stage,"ppt"=>$ppt]);        }           //上传文件        public function actionAdd_pptfile(){                $data=date('Ym');                $targetFolder = '/xuetang/uploads/ppt/'.$data; // Relative to the root                $verifyToken = md5('unique_salt' . $_POST['timestamp']);                if (!empty($_FILES) && $_POST['token'] == $verifyToken) {                $tempFile = $_FILES['Filedata']['tmp_name'];                $targetPath = $_SERVER['DOCUMENT_ROOT'] . $targetFolder;                //$targetFile = rtrim($targetPath,'/') . '/' . $_FILES['Filedata']['name'];                $targetFile = rtrim($targetPath,'/') . '/' .time().  rand(10, 99).'.ppt';                // Validate the file type                $fileTypes = array('ppt','pptx','swf','jpg'); // File extensions                $fileParts = pathinfo($_FILES['Filedata']['name']);                if (in_array($fileParts['extension'],$fileTypes)) {                            if(!is_dir($targetPath)){                                mkdir($targetPath);                            }                            move_uploaded_file($tempFile,$targetFile);                            echo $targetFile;                    } else {                            echo 'Invalid file type.';                    }                }        }            //添加PPT        public function actionAdd_ppt(){            $c_id=$_POST['c_id'];            $mid=$_POST['mid'];            $sid=$_POST['sid'];            $cid=$_POST['cid'];            $ch_id=$_POST['ch_id'];            $p_title=$_POST['p_title'];            $p_desc=$_POST['p_desc'];            $path=$_POST['path'];            $path=  str_replace($_SERVER['DOCUMENT_ROOT'], "", $path);            $addtime=time();            $start_num= strrpos($path,'/');            //echo $start_num;die;            $new_path = substr($path,$start_num+1);            $end_num= strrpos($new_path,'.');            //echo $end_num;die;            $p_name = substr($new_path,0,$end_num);            //echo $p_name;die;           // print_r($_POST);die;            $sql="insert into ppt(c_id,cid,mid,sid,p_title,p_desc,addtime,ch_id,link,p_name) VALUES ('$c_id','$cid','$mid','$sid','$p_title','$p_desc','$addtime','$ch_id','$path','$p_name')";            //echo $sql;die;            if(Yii::$app->db->createCommand($sql)->query()){                echo "<script>alert('ok');location.href='index.php?r=user/ppt/ppt_list'</script>";            }else{                echo "<script>alert('false');location.href='index.php?r=user/ppt/ppt_add'</script>";            }        }                    //显示PPT列表        public function actionPpt_list(){       // $sql="select * from ppt,chapter,college where ppt.ch_id=chapter.ch_id and ppt.c_id=college.c_id";		//print_r($sql);die;		//$data=Yii::$app->db->createCommand($sql)->queryAll();	//查询所有PPT        $where = 'where ppt.ch_id=chapter.ch_id and ppt.c_id=college.c_id ';        $search_params = '';        if (isset($_REQUEST['search'])) {            $search = $_REQUEST['search'];            if (isset($_GET['search'])) {                $search = base64_decode($search);            }            $where.= " and chapter.ch_name like '%$search%'";            $where.=" order by ppt.addtime desc";             $search = base64_encode($search);            $search_params = '&search=' . $search;        }        //echo $search_params;die;        #总记录数        $sql = "select count(*) num from ppt,chapter,college $where";        $count = Yii::$app->db->createCommand($sql)->queryScalar();        $listRows = 7;        $pages = ceil($count / $listRows);        if (isset($_GET['p'])) {            $page = $_GET['p'];        } else {            $page = 1;        }        //偏移量        $firstRow = ($page - 1) * $listRows;        $sql = "select ppt.*,chapter.ch_id,chapter.ch_name,college.c_id,college.c_name,major.m_name from ppt,chapter,college,major $where limit $firstRow,$listRows";        $data = Yii::$app->db->createCommand($sql)->queryAll();           // var_dump($data);die;        #页码        $uppage = $page - 1;        if ($uppage <= 1) {            $uppage = 1;        }        $downpage = $page + 1;        if ($downpage >= $pages) {            $downpage = $pages;        }        $str = "<div style='width:100%;text-align:right;'><ul class='pagination' style='margin-top:0;'>";        $str .= "<li><a href='index.php?r=user/ppt/ppt_list&p=1" . $search_params . "'>&laquo;</a></li>";        $str .= "<li><a href='index.php?r=user/ppt/ppt_list&p=$uppage" . $search_params . "'>&lsaquo;</a></li>";        $page_start = $page >= 10 ? $page - 8 : 1;        if ($pages > 10) {            $page_end = 10;            $page_end = $page >= 10 ? $page + 1 : $page_end;            if ($page_end >= $pages) {                $page_end = $pages;                $page_start = $pages - 9;            }        } else {            $page_end = $pages;        }        for ($i = $page_start; $i <= $page_end; $i++) {            if ($page == $i) {                $str .= "<li class='active disabled'><a href='javascript:void(0)'>$i</a></li>";            } else {                $str .= "<li><a href='index.php?r=user/ppt/ppt_list&p=$i" . $search_params . "'>$i</a></li>";            }        }        $str .= "<li><a href='index.php?r=user/ppt/ppt_list&p=$downpage" . $search_params . "'>&rsaquo;</a></li>";        $str .= "<li><a href='index.php?r=user/ppt/ppt_list&p=$pages        " . $search_params . "'>&raquo;</a></li>";        $str .= "</ul></div>";	if($count==0){		$str="";	}		return $this->render('ppt_list',["ppt_list"=>$data,"pagenum"=>$str]);              }    //修改ppt    public function actionPpt_update()    {       $id=$_GET['p_id'];         $sql = "select * from  ppt INNER JOIN college on college.c_id=ppt.c_id INNER JOIN chapter on chapter.ch_id=ppt.ch_id inner JOIN major on major.m_id=ppt.mid INNER JOIN stage on stage.sid=ppt.sid where p_id=$id";        $data = Yii::$app->db->createCommand($sql)->queryOne();        $sql1="select c_id,c_name from college";        $data1 = Yii::$app->db->createCommand($sql1)->queryAll();        $sql2="select m_id,m_name from major";        $data2 = Yii::$app->db->createCommand($sql2)->queryAll();        $sql3="select ch_id,ch_name from chapter";        $data3 = Yii::$app->db->createCommand($sql3)->queryAll();      //  var_dump($data2);die;        //var_dump($data);die;        return $this->render('ppt_update',["data"=>$data,'college'=>$data1,'id'=>$id,'major'=>$data2,'chapter'=>$data3]);    }    //提交修改   public function actionUpp_ppt()   {       header("Content-type:text/html;charset=utf-8");       $file=$_FILES['myfile']['name'];       $length=strrpos($file,'.');       $geshi=substr($file,$length+1);       $data=date('Ym',time());      // var_dump($_POST);die;        if($geshi!=='pptx'&&$geshi!=='ppt')       {           //echo '格式不正确';          //echo  $_SERVER['HTTP_REFERER'];           //die;           echo "<script>alert('格式不正确');window.history.go(-1)</script>";           die;        }       if(!file_exists('../../../../uploads/ppt/'.$data)){          mkdir('../../../../uploads/ppt/'.$data);       }       /*$link=$_POST['link'];       unlink($link);*/       //       $time=time();       move_uploaded_file($_FILES['myfile']['tmp_name'],'../../../../uploads/ppt/'.$data.'/'.$time.'.ppt');       $p_title=$_POST['p_title'];       $c_id=$_POST['c_id'];       $ch_id=$_POST['ch_id'];       $p_desc=$_POST['p_desc'];       $m_id=$_POST['m_id'];       $path='/xuetang/uploads/ppt/'.$data.'/'.$time.'.ppt';       $p_id=$_POST['p_id'];        $sql="update ppt set p_title='$p_title',c_id=$c_id,ch_id=$ch_id,p_desc='$p_desc',mid=$m_id,link='$path' where p_id=$p_id";      if( Yii::$app->db->createCommand($sql)->query())      {          echo "<script>alert('修改成功');location.href='index.php?r=user/ppt/ppt_list'</script>";      }else      {          echo "<script>alert('修改失败');window.history.go(-1)</script>";      }   }    	//删除	public function actionDel_ppt(){            $id=Yii::$app->request->post('p_id');            $sql="delete from ppt where p_id='$id'";            $data=Yii::$app->db->createCommand($sql)->query();                if($data){                    echo 1;                }else{                    echo 0;                 }	}                        //批量删除	public function actionDelall_ppt(){            //echo 11;            $id=Yii::$app->request->post('p_id');            //print_r($id);die;            $p_id=implode(",",$id);            $sql="delete from ppt where p_id in ($p_id)";            $data=Yii::$app->db->createCommand($sql)->query();            if($data){                echo 1;            }else{                echo 0;             }	}                        //章节搜索        public function actionPpt_search(){            $ppt_search=$_POST['ppt_search'];            $sql="select * from ppt,chapter,college where ppt.ch_id=chapter.ch_id and ppt.c_id = college.c_id and ch_name like '%$ppt_search%'";            $data=Yii::$app->db->createCommand($sql)->queryAll();            //print_r($data);die;            echo json_encode($data);        }                        //查询专业        public function actionCktwo(){            $one=$_POST['one'];                    //print_r($one);die;            $sql="select * from major where c_id='$one'";             $two= Yii::$app->db->createCommand($sql)->queryAll();            //print_r($two);die;            echo json_encode($two);        }		  //查询课程        public function actionCksix(){            $one=$_POST['one'];            $two=$_POST['two'];            $six=$_POST['six'];            $sql="select * from course where c_id='$one' and mid='$two' and sid='$six'";            $sixs= Yii::$app->db->createCommand($sql)->queryAll();            echo json_encode($sixs);        }        //查询章节        public function actionCkfour(){            $four=$_POST['four'];            $sql="select * from chapter where cid='$four'";            $five=Yii::$app->db->createCommand($sql)->queryAll();            //print_r($five);            echo json_encode($five);        }                    //下载文件        public function actionXiazai(){            header("content-type:text/html;charset=utf-8");            $file_name=$_SERVER['DOCUMENT_ROOT'].'/'.$_GET['link'];//获取路径            //echo $file_name;die;            //判断文件是否存在            if(!file_exists($file_name)){                echo "<script>alert('文件不存在，请重新选择');history.go(-1);</script>";                die;            }            //截取文件名称            $name=substr($file_name,18);            //echo $name;die;            //下载文件的header头            header("Content-type:application/octet-stream");            header("Accept-Ranges:bytes");            header("Accept-Length:".strlen($file_name));            header('Content-Disposition:attachment;filename='.$name);            readfile($file_name);        }                //分页       }